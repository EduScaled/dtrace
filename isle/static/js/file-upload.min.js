$(document).ready(function(){for(var e=$("form.trace-form"),a=0;a<e.length;a++)$(e[a]).areYouSure();function n(e){var a=e.find("input[name=url_field]"),i=e.find("input[name=file_field]");return!!a.first().val()!=!(!i||!i.val())}function r(e){n(e)?e.find(".add-material-btn").removeAttr("disabled").prop("disabled",!1):e.find(".add-material-btn").attr("disabled","disabled").prop("disabled",!0)}COUNTER=0,UPLOADS=[],e.submit(function(e){e.preventDefault();var t=$(e.target);if(UPLOADS.length>=MAX_PARALLEL_UPLOADS&&t.find("input[name=file_field]")[0].files.length)alert("Максимальное количество одновременно загружаемых файлов не может превышать "+MAX_PARALLEL_UPLOADS);else{var a=new FormData(this);if(a.append("add_btn",""),n(t)){var i=function(e){var a=e.find("input[name=file_field]")[0].files;if(0!=a.length){var i=a[0].name,n=COUNTER++,t='<div class="row upload-row" data-row-number="'+n+'"><div class="col-lg-3 uploads-name"><span class="uploaded-file-name">'+i+'</span></div><div class="col-lg-9 uploads-progress" style="padding-top: 5px"><div class="progress"><div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div></div></div></div>';return t=$(t),e.find("div.uploads").append(t),UPLOADS.push(n),n}}(t);t.find("span.file-name").html(""),t.find("input[name=url_field]").val(""),t.find("input[name=file_field]").val(""),r(t),$.ajax({type:"POST",data:a,processData:!1,contentType:!1,xhr:function(){var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",function(e){if(e.lengthComputable){var a=e.loaded/e.total;a=parseInt(100*a),$('div.upload-row[data-row-number="'+i+'"]').find(".progress-bar").css("width",a+"%")}},!1),e},success:function(e){var a=e.url,i=e.material_id,n=t.children("ul.list-group").children("li");$(n[n.length-1]).before($('<li class="list-group-item"><a href="'+a+'">'+a+'</a>&nbsp;<button name="material_id" value="'+i+'" class="btn btn-warning btn-sm pull-right delete-material-btn">Удалить</button></li>'))},complete:function(){$('div.upload-row[data-row-number="'+i+'"]').remove();var e=UPLOADS.indexOf(i);-1<e&&UPLOADS.splice(e,1)},error:function(e,a){alert("error")}})}}}),$("body").delegate("button.delete-material-btn","click",function(e){if((e.preventDefault(),"material_id"==$(":focus").attr("name"))&&confirm("Вы действительно хотите удалить этот файл?")){var a=$(this),i=a.parents("form.trace-form"),n={trace_name:i.children("input[name=trace_name]").val(),csrfmiddlewaretoken:i.children("input[name=csrfmiddlewaretoken]").val(),material_id:a.val()};$.ajax({type:"POST",data:n,success:function(e){a.parent("li").remove()},error:function(e,a){alert("error")}})}}),$("body").delegate("form.trace-form input[type=file]","change",function(e){window.FileReader&&this.files&&this.files[0]&&this.files[0].size>1024*MAX_SIZE*1024&&($(this).val(""),alert("Максимальный размер файла не должен превышать "+MAX_SIZE+"Мб"))}),$("body").delegate("input[name=url_field]","keyup change",function(e){r($(this).parents("form.trace-form"))}),$("body").delegate("input[name=file_field]","change",function(e){r($(this).parents("form.trace-form")),$(this)[0].files[0]&&$(this).parents("li").find("span.file-name").html($(this)[0].files[0].name)}),$(window).bind("beforeunload",function(){if(0!=UPLOADS.length)return"не все загрузки завершены"})});