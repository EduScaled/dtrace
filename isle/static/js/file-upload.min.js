$(document).ready(function(){function r(e){var t=e.find("input[name=url_field]"),a=e.find("input[name=file_field]");return!!t.first().val()!=!(!a||!a.val())}function l(e){r(e)?e.find(".add-material-btn").removeAttr("disabled").prop("disabled",!1):e.find(".add-material-btn").attr("disabled","disabled").prop("disabled",!0)}$("form.trace-form").submit(function(e){e.preventDefault();var t=new FormData(this);t.append("add_btn","");var i=$(e.target);if(r(i)){var a=i.find("div.progress");a.show();var n=a.children(".progress-bar");n.css("width","0%"),$.ajax({type:"POST",data:t,processData:!1,contentType:!1,xhr:function(){var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=e.loaded/e.total;t=parseInt(100*t),n.css("width",t+"%")}},!1),e},success:function(e){var t=e.url,a=e.material_id,n=i.children("ul.list-group").children("li");$(n[n.length-1]).before($('<li class="list-group-item"><a href="'+t+'">'+t+'</a>&nbsp;<button name="material_id" value="'+a+'" class="btn btn-warning btn-sm pull-right delete-material-btn">Удалить</button></li>')),i.find("input[name=url_field]").val(""),i.find("input[name=file_field]").val(""),i.find("input[name=comment]").val(""),i.find("span.file-name").html(""),l(i)},complete:function(){a.hide()},error:function(e,t){alert("error")}})}}),$("body").delegate("button.delete-material-btn","click",function(e){if(e.preventDefault(),confirm("Вы действительно хотите удалить этот файл?")){var t=$(this);if("material_id"==$(":focus").attr("name")){var a=t.parents("form.trace-form"),n={trace_name:a.children("input[name=trace_name]").val(),csrfmiddlewaretoken:a.children("input[name=csrfmiddlewaretoken]").val(),material_id:t.val()};$.ajax({type:"POST",data:n,success:function(e){t.parent("li").remove()},error:function(e,t){alert("error")}})}}}),$("body").delegate("form.trace-form input[type=file]","change",function(e){window.FileReader&&this.files&&this.files[0]&&this.files[0].size>1024*MAX_SIZE*1024&&($(this).val(""),alert("Максимальный размер файла не должен превышать "+MAX_SIZE+"Мб"))}),$("body").delegate("input[name=url_field]","keyup change",function(e){l($(this).parents("form.trace-form"))}),$("body").delegate("input[name=file_field]","change",function(e){l($(this).parents("form.trace-form")),$(this).parents("li").find("span.file-name").html($(this)[0].files[0].name)})});