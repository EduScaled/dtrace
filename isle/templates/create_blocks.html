{% extends 'base.html' %}
{% load static %}

{% block content %}
    <div class="row">
    <div class="col">
        <h2>{{ event.title }}</h2>
        <div class="pull-right">
            <a href="{% url 'event-view' uid=event.uid %}">
                <button class="btn btn-light">К странице мероприятия</button>
            </a>
        </div>
    </div>
    </div>
    <div class="row"><h3>Структура мероприятия</h3></div>
    <br>
    <div>
        <table class="table">
            {% for b in blocks %}
                <tr>
                    <td>{{ b.duration }}</td>
                    <td>{{ b.title }}</td>
                    <td>{{ b.get_block_type_display }}</td>
                    <td>
                        <form action="{% url 'delete-block' uid=event.uid block_id=b.id %}" method="post">
                            {% csrf_token %}
                            <button class="btn btn-danger" type="submit">Удалить</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>
    <form method="post" id="blocks-form">
        {% csrf_token %}
        {{ formset.management_form }}
        {% for form in formset %}
            <div class="form-inline">
                <div>
                    <div class="row form-row spacer">
                        {% for field in form %}
                            {{ field|add_class:"form-control"|set_placeholder:field.label }}
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
        <div class="row" style="margin-top: 20px">
            <button id="save-blocks" class="btn btn-danger" style="margin-left: 10px">Сохранить</button>
        </div>
    </form>

{% endblock %}

{% block js %}
    {{ block.super }}
    <script src="{% static 'js/libs/jquery.formset.js' %}"></script>
    <script type="text/javascript">

    function check_form_row(form_row) {
        var inputs = [form_row.find('input[name$=duration]'), form_row.find('input[name$=title]'), form_row.find('select[name$=block_type]')];
        for (var i = 0; i < inputs.length; i++) {
            if (!$(inputs[i]).val())
                $(inputs[i]).addClass('field-error');
        }
    }

    $(document).ready(function() {
        $('.form-row').formset({
            addText: '<span class="glyphicon glyphicon-plus-sign"></span> Добавить',
            addCssClass: 'add-formset-btn',
            deleteText: 'Удалить',
            deleteCssClass: 'delete-formset-btn'
        });

        $('#blocks-form').on('submit', function(e) {
            var rows = $(this).find('.form-row');
            $('.field-error').removeClass('field-error');
            for (var i = 0; i < rows.length; i++) {
                check_form_row($(rows[i]));
            }
            if ($('.field-error').length) {
                e.preventDefault();
                return false;
            }
        });
    })
    </script>
{% endblock %}

{% block css %}
    {{ block.super }}
    <link href="{% static 'css/bootstrap-glyphicons.min.css' %}" rel="stylesheet">
    <style>
        .field-error {
            border-color: red;
        }
        .delete-formset-btn:first-of-type {
            display: none;
        }
        .delete-formset-btn {
            margin: auto 10px;
        }
    </style>
{% endblock %}
